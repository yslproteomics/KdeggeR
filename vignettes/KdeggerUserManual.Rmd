---
title: "KdeggeR user manual"
author: "Barbora Salovska"
date: "Last edited `r format(Sys.Date(), '%A %d %B %Y')`"
output:
  rmdformats::readthedown:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: false
    number_sections: yes
    toc_depth: 3
    toc_float: yes
pkgdown:
  as_is: true    
vignette: >
  %\VignetteIndexEntry{KdeggerUserManual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Load the package

## Install dependencies

```{r install dependencies, eval = FALSE}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(devtools, dplyr, outliers, parallel, purrr, stats, stringr)
```

## Install KdeggeR

```{r install KdeggeR, eval = FALSE}
library("devtools")
install_github("yslproteomics/KdeggeR")
```

## Load KdeggeR

```{r load KdeggeR}
library(KdeggeR)
```

# Required files 
1. Precursor-level data exported in .tsv format
2. Design table saved in .tsv format - a template can be generated (see below)
3. OPTIONAL: Table with experimentally determined kcd values in .tsv format

# Generate pSILAC object

## Generate design template

This function takes the MS data processing results and generate a template *design_table_template.xls* file with required columns. 
This can be completed manually by the user, saved as a .tsv file, and used as an input for the `generatepSILACObject()` function.
See provided examples for designs with a replicate and non-replicate design on the data structure. 

```{r generate design table, eval = FALSE}
# use libpath here
data_file <- paste(.libPaths()[1], "KdeggeR/data/example_data_pSILAC_SN19_A2780Cis_Nor_full_truncated.tsv", sep = "/")

# See ?generateDesignTemplate
KdeggeR::generateDesignTemplate(dataset = data_file, inputDataType = "spectronaut")
```

## Generate pSILAC object without replicate design

```{r generate pSILAC object, eval = FALSE}
design_table_customized <- paste(.libPaths()[1], "KdeggeR/data/example_design_table_pSILAC_SN19_A2780Cis_Nor.txt", sep = "/")

# See ?generatepSILACObject
o <- KdeggeR::generatepSILACObject(dataset = data_file, 
                                   design = design_table_customized, 
                                   inputDataType = "spectronaut", # inputDataType needs to be correctly specified
                                   aggregate.replicates = NA, # if NA, replicates are not aggregated
                                   ncores = 1, # can be increased for faster processing, use parallel:: detectCores() to detect available cores
                                   noiseCutoff = 8) # intensity cutoff recommended for Spectronaut output data

```

## Generate pSILAC object with replicate design

The replicates will be averaged during the pSILAC object generation. This design is advisable when processing experiments with, e.g., replicate injections or dish replicates which are not meant to be analyzed separately.

It is recommended to use cross-run normalized data if replication aggregation is intended. 

```{r generate pSILAC object with replicates, eval = FALSE}
design_table_customized_replicates <- paste(.libPaths()[1], "KdeggeR/data/example_design_table_pSILAC_SN19_A2780Cis_Nor_replicate_design.txt", sep = "/")

o_agg <- KdeggeR::generatepSILACObject(dataset = data_file, 
                                       design = design_table_customized_replicates, 
                                       inputDataType = "spectronaut", 
                                       aggregate.replicates = "median")
```

# Filter data

```{r filter input data, eval = FALSE}
o <- filterValidValues(o, values_cutoff = 2, skip_time_point = 1)
o <- filterMonotone(o, skip_time_point = 1)
o <- filterMonotoneTimePoint1(o)
o <- filterLinearRegression(o, skip_time_point = 1, R2_cutoff = 0.9, p_cutoff = 0.05)
```

# Fit models to estimate Kloss

## Calculate all rates

The `calcAllRates()` function is a wrapper function that runs precursor kloss calculation using the RIA, ln(H/L +1), and NLI data. 

Then it aggregates the precursor-level estimates into protein kloss estimates using the selected method.

```{r fit all rates, eval = FALSE}
o <- calcAllRates(o, method = "complement", 
                  ag.metric = "mean", 
                  ag.weights = "both")
```

## Calculate specific rates

The model fitting functions can be also run separately using the following functions. 

```{r fit selected rates, eval = FALSE}
# Precursor-level kloss
o <- calcRIAkloss(o, ncores = 1)
o <- calcNLIkloss(o, startIntensity = "max", ncores = 1)
o <- calcHoLkloss(o, tryRobust = FALSE, ncores = 1)

# Aggregate to protein-level kloss
o <- calcProteinsKloss(o, method = "complement", 
                       ag.metric = "mean", 
                       ag.weights = "both", 
                       ncores = 1, 
                       returnKlossTableOnly = F, 
                       returnSD = F )

# Aggregate to protein-level kloss, export protein-level kloss table in a new object
protein_kloss_table <- calcProteinsKloss(o, method = "complement", 
                       ag.metric = "mean", 
                       ag.weights = "both", 
                       ncores = 1, 
                       returnKlossTableOnly = T, 
                       returnSD = F )
```

# Calculate kdeg 

## Import experimentally-determined kcd values

## Estimate kperc

## Calculate kdeg

## Calculate t(1/2)

# Visulize Results

## Precursor/peptide

### Plot precursor RIA model

### Plot precursor NLI model

### Plot precursor ln(H/L +1) model

## Protein

### Plot protein model

### Plot protein summary
